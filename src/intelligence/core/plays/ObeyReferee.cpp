/*
Command type 	Command Description 	Command
=================================================================================
Control commands
	Halt 	                        H
	Stop 	                        S
	Ready 	                        ' ' (space character)
	Start 	                        s
Game Notifications
	Begin first half 	        1
	Begin half time 	        h
	Begin second half 	        2
	Begin overtime half 1 	        o
	Begin overtime half 2 	        O
	Begin penalty shootout 	        a

	Command type 	Command Description 	Yellow Team Command 	Blue Team Command
	=================================================================================
	Game restarts
	Kick off 	                k                       K
	Penalty 	                p 	                P
	Direct Free kick 	        f 	                F
	Indirect Free kick 	        i 	                I
	Extras
	Timeout 	                t 	                T
	Timeout end 	                z 	                z
	Goal scored 	                g 	                G
	decrease Goal score 	        d 	                D
	Yellow Card 	                y 	                Y
	Red Card 	                r 	                R
	Cancel 	                        c
*/

#include "ObeyReferee.h"
#include "Ball.h"
#include "StopReferee.h"
#include "Halt.h"
#include "PenaltyThem.h"
#include "PenaltyUs.h"
#include "IndirectKick.h"
#include <cmath>

using std::pow;

#define DELTA 200

using namespace LibIntelligence;
using namespace LibIntelligence::Plays;

ObeyReferee::ObeyReferee(QObject *q, Play *p, Robot* gk, Robot* pKicker)
	: Play(q, p->team(), p->stage()),
	play(p),
	stopReferee(new StopReferee(this, p->team(), p->stage(), gk)),
	halt(new Halt(this, p->team(), p->stage())),
	penaltyUs(new PenaltyUs(this, p->team(), p->stage(), pKicker, gk)),
	penaltyThem(new PenaltyThem(this, p->team(), p->stage(), gk)),
	indirectKick(new IndirectKick(this, p->team(), p->stage(), gk, 3000)),
	cmd('H'),
	lastCmd('H'),
	kickTo(new KickTo(this,pKicker))
{
	pKicker_=pKicker;
}

ObeyReferee::~ObeyReferee()
{
	delete play;
	delete halt;
	delete stopReferee;
}

void ObeyReferee::setPlay(Play *p)
{
	if(p != play) {
		delete play;
		play = p;
	}
}

void ObeyReferee::setTeam(Team *t)
{
	if(t != team()) {
		Play::setTeam(t);
		play->setTeam(t);
		halt->setTeam(t);
		stopReferee->setTeam(t);
	}
}

void ObeyReferee::setStage(Stage *s)
{
	if(s != stage()) {
		Play::setStage(s);
		play->setStage(s);
		halt->setStage(s);
		stopReferee->setStage(s);
	}
}

void ObeyReferee::setGoalkeeper(Robot* gk)
{
    ((StopReferee*)stopReferee)->setGoalkeeper(gk);
    ((PenaltyUs*)penaltyUs)->setGoalkeeper(gk);
    ((PenaltyThem*)penaltyThem)->setGoalkeeper(gk);
}

void ObeyReferee::setPenaltyKicker(Robot* pk)
{
	((PenaltyUs*)penaltyUs)->setPenaltyKicker(pk);
}

void ObeyReferee::step()
{
	bool firstTime=false;

	Stage *sta = this->stage();
	qreal dist=-1;

	Ball *ball = sta->ball();

	dist = sqrt(pow(lastBall.x() - ball->x(), 2) + pow(lastBall.y() - ball->y(), 2));
	//Commands Referee
	if(cmd != sta->getCmdReferee()){
		lastCmd = cmd;
		cmd = sta->getCmdReferee();
		lastBall = *ball;
		firstTime=true;
	}

#ifdef REFERRE_CMD
	cout << "JUIZ: " << cmd << endl;
#endif


	//if(lastCmd != cmd){
	////	lastCmd = cmd;
	//	lastBall = *ball;
	//}

	TeamColor usColor = team()->color();

	//Comportamento muda caso a bola tenha se deslocado
	if(cmd == 'f' && usColor == YELLOW)
		play->step();
	else if((cmd ==' ' || cmd =='s') && ((lastCmd=='p' && usColor==YELLOW) || (lastCmd=='P' && usColor==BLUE))){
		kickTo->setPoint(penaltyTarget);
		kickTo->step();
		if(pKicker_->touchedBall())
		{
			lastCmd='s';
		}
	}
	else if(cmd == 'f' && usColor == BLUE){
		if(dist<DELTA && ball->speed().length() < DELTA)
			stopReferee->step();
		else{
			//lastBall = *ball;
			play->step();
		}
	}
	else if(cmd == 'F' && usColor == YELLOW){
		if(dist<DELTA && ball->speed().length() < DELTA)
			stopReferee->step();
		else{
			//lastBall = *ball;
			play->step();
		}
	}
	else if(cmd == 'F' && usColor == BLUE)
		play->step();

	else if(cmd == 'i' && usColor == YELLOW) {
		if(firstTime){
			((IndirectKick*)indirectKick)->restart();
		}
		indirectKick->step();
		if(((IndirectKick*)indirectKick)->finished()){
			play->step();
		} 
	}

	else if(cmd == 'i' && usColor == BLUE){
		if(dist<DELTA && ball->speed().length() < DELTA)
			stopReferee->step();
		else{
			//lastBall = *ball;
			play->step();
		}
	}

	else if(cmd == 'I' && usColor == YELLOW){
		//FIXME fix the the threshold
		if(dist<DELTA && ball->speed().length() < DELTA)
			stopReferee->step();
		else{
			//lastBall = *ball;
			play->step();
		}
	}
	else if(cmd == 'I' && usColor == BLUE) {
		if(firstTime){
			((IndirectKick*)indirectKick)->restart();
		}
		indirectKick->step();
		if(((IndirectKick*)indirectKick)->finished()){
			play->step();
		}
	}
	else if(cmd == 'k' || cmd == 'K')
		stopReferee->step();
    else if((cmd == 'p' && usColor == YELLOW) || (cmd == 'P' && usColor == BLUE)){
		penaltyUs->step();
		penaltyTarget=Point(*(pKicker_->enemyGoal()));
	}
    else if((cmd == 'P' && usColor == YELLOW) || (cmd == 'p' && usColor == BLUE))
		penaltyThem->step();

	//Penalty, kickoff, normal start e force start (ordem dos else if importa)
	else if(cmd == ' ' && (lastCmd == 'k' || lastCmd == 'p') && usColor == YELLOW)
		play->step();
    else if(cmd == ' ' && lastCmd == 'k' && usColor == BLUE){
		if(dist<DELTA && ball->speed().length() < DELTA)
			stopReferee->step();
		else{
			//lastBall = *ball;
			play->step();
		}
	}
    else if(cmd == ' ' && lastCmd == 'p' && usColor == BLUE){
		if(dist<DELTA && ball->speed().length() < DELTA)
			penaltyThem->step();
		else{
			//lastBall = *ball;
			play->step();
		}
	}
    else if(cmd == ' ' && lastCmd == 'K' && usColor == YELLOW){
		if(dist<DELTA && ball->speed().length() < DELTA)
			stopReferee->step();
		else{
			//lastBall = *ball;
			play->step();
		}
	}
    else if(cmd == ' ' && lastCmd == 'P' && usColor == YELLOW){
		if(dist<DELTA && ball->speed().length() < DELTA)
			penaltyThem->step();
		else{
			//lastBall = *ball;
			play->step();
		}
	}
    else if(cmd == ' ' && (lastCmd == 'K' || lastCmd == 'P') && usColor == BLUE)
		play->step();

	else if(cmd == ' ')
		play->step();
	else if(cmd == 's')
		play->step();

	//Comportamento halt, stop e jogo
	else if(cmd == 'H')
		halt->step();
	else if(cmd == 'S')
		stopReferee->step();
	else if(cmd == '1' || cmd == 'h' || cmd == '2' || cmd == 'o' || cmd == 'O' || cmd == 'a')
		stopReferee->step();
	else if(cmd == 't' || cmd == 'T')
		halt->step();
	else if(cmd == 'z' || cmd == 'g' || cmd == 'G' || cmd == 'd' || cmd == 'D' || cmd == 'y' || cmd == 'Y' || cmd == 'r' || cmd == 'R' || cmd == 'c')
		stopReferee->step();
	else
		play->step();
}
